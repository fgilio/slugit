<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
        <meta http-equiv="x-ua-compatible" content="ie=edge" />

        <link rel="manifest" href="/manifest.webmanifest" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="slugit" />
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
        <meta name="msapplication-TileColor" content="#4A4972" />
        <meta name="theme-color" content="#4A4972" />

        <title>slugit</title>
        <meta name="description" content="slugit is a handy URL based slug generator" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content="slugit" />
        <meta name="twitter:description" content="slugit is a handy URL based slug generator" />
        <meta name="twitter:image" content="https://slugit.dev/android-chrome-512x512.png" />
        <meta name="twitter:creator" content="@fgili0" />

        <meta property="og:url" content="https://slugit.dev/" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="slugit is a handy URL based slug generator" />
        <meta property="og:description" content="slugit" />
        <meta property="og:image" content="https://slugit.dev/android-chrome-512x512.png" />
    </head>

    <body>
        <main>
            <p></p>
            <input type="text" />
            <br>
            <h1 title="Click to copy to clipboard"></h1>

            <ul>
                <li>
                    <a href="https://github.com/fgilio/slugit">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <title>GitHub</title>
                            <path
                                d="M10 0a10 10 0 0 0-3.16 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94 0-1.1.39-1.99 1.03-2.69a3.6 3.6 0 0 1 .1-2.64s.84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69 0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0 0 10 0"
                            ></path>
                        </svg>
                    </a>
                </li>
                <li>
                    <a href="https://twitter.com/fgili0/">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <title>üëãüèº Twitter</title>
                            <path
                                d="M6.29 18.25c7.55 0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12 0 0 0 1.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1 0 0 0-7 3.74 11.65 11.65 0 0 1-8.45-4.3 4.1 4.1 0 0 0 1.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1 0 0 0 3.3 4.03 4.1 4.1 0 0 1-1.86.07 4.1 4.1 0 0 0 3.83 2.85A8.23 8.23 0 0 1 0 16.4a11.62 11.62 0 0 0 6.29 1.84"
                            ></path>
                        </svg>
                    </a>
                </li>
            </ul>
        </main>

        <style>
            html {
                box-sizing: border-box;
            }
            body {
                display: flex;
                align-items: center;
                height: 100vh;
                background-color: #f4f4f5;
                padding: 0;
                margin: 0;
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
            }
            main {
                width: 100%;
                margin: 0 20px;
            }
            p {
                font-size: 15.75px;
                line-height: 1.45;
                font-family: monospace;
                text-align: left;
                color: #495254;
                padding: 3px 12px;
                margin: 0;
                width: 90%;
            }
            input {
                font-size: 20px;
                line-height: 1.45;
                font-family: monospace;
                color: #495254;
                border-radius: 3px;
                border-style: hidden;
                padding: 3px 12px;
                margin: 30px 0 10px 0;
                width: 90%;
            }
            input:focus {
                box-shadow: 0 0 1px rgba(74, 73, 114, 0.26) inset, 0 0 8px rgba(74, 73, 114, 0.1);
                outline: 0 none;
            }
            h1 {
                position: relative;
                display: inline-block;
                font-size: 30px;
                line-height: 1.45;
                font-family: monospace;
                color: #495254;
                -webkit-user-select: all;
                -moz-user-select: all;
                user-select: all;
                border-radius: 3px;
                transition: all 70ms ease-out;
                padding: 10px 40px 10px 10px;
                margin: 0;
            }
            h1:after {
                display: block;
                height: 30px;
                width: 30px;
                position: absolute;
                top: 50%;
                right: 5px;
                transform: translateY(-50%);
                content: url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3Csvg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 128 128' style='enable-background:new 0 0 128 128;' xml:space='preserve'%3E%3Cpath d='M73.5,14.5H45.1c-5.3,0-9.6,4.1-9.6,9.4v2h-1.8c-5.3,0-9.6,4.1-9.6,9.4v68.6c0,5.3,4.4,9.6,9.6,9.6h49.5 c5.3,0,9.4-4.4,9.4-9.6v-1.8h2c5.3,0,9.4-4.4,9.4-9.6V45L73.5,14.5z M73.5,25.1L93.4,45H73.5V25.1z M85,103.9c0,1.1-0.8,2-1.8,2 H33.6c-1,0-2-1-2-2V35.3c0-1,0.9-1.8,2-1.8h1.8v60.8c0,5.3,2.5,7.7,7.7,7.7H85V103.9z M96.4,92.5c0,1.1-0.8,2-1.8,2H45.1 c-1,0-2-1-2-2V23.9c0-1,0.9-1.8,2-1.8h20.8v30.5h30.5V92.5z'/%3E%3C/svg%3E%0A");
                opacity: 0.5;
                transition: all 70ms ease-out;
            }
            h1:hover {
                background-color: hsl(191, 7%, 31%, 0.1);
                transition: all 10ms ease-in;
            }
            h1:active {
                background-color: hsl(191, 7%, 31%, 0.3);
                transition: all 10ms ease-in;
                color: white;
                background-color: #4a4972;
            }
            h1:active:after {
                transition: all 10ms ease-in;
                filter: invert(1);
                opacity: 1;
            }
            h1::selection {
                background-color: transparent;
            }

            ul {
                list-style: none;
                position: fixed;
                bottom: 10px;
                display: block;
                width: 100%;
                text-align: center;
                right: 0;
                left: 0;
                margin: 0;
                padding: 0;
            }
            li {
                display: inline-block;
                width: 30px;
                height: 30px;
                padding: 10px;
                opacity: 0.7;
            }
        </style>
        <script>
            /*
             * From https://medium.com/@mhagemann/the-ultimate-way-to-slugify-a-url-string-in-javascript-b8e4a0d849e1
             */
            const slugify = string => {
                const a = '√†√°√§√¢√£√•ƒÉ√¶√ß√®√©√´√™«µ·∏ß√¨√≠√Ø√Æ·∏ø≈Ñ«π√±√≤√≥√∂√¥≈ì√∏·πï≈ï√ü≈õ»ô»õ√π√∫√º√ª«ò·∫É·∫ç√ø≈∫¬∑/_,:;';
                const b = 'aaaaaaaaceeeeghiiiimnnnooooooprssstuuuuuwxyz------';
                const p = new RegExp(a.split('').join('|'), 'g');
                return string
                    .toString()
                    .toLowerCase()
                    .replace(/\s+/g, '-') // Replace spaces with -
                    .replace(p, c => b.charAt(a.indexOf(c))) // Replace special characters
                    .replace(/&/g, '-and-') // Replace & with ‚Äòand‚Äô
                    .replace(/[^\w\-]+/g, '') // Remove all non-word characters
                    .replace(/\-\-+/g, '-') // Replace multiple - with single -
                    .replace(/^-+/, '') // Trim - from start of text
                    .replace(/-+$/, ''); // Trim - from end of text
            };
            const copyToClipboard = string => {
                const el = document.createElement('textarea');
                el.value = string;
                el.setAttribute('readonly', '');
                el.style.position = 'absolute';
                el.style.left = '-9999px';
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
            };
            /*
             * decodeURI doesn't cut it because we may have actual % in the path.
             * https://github.com/SamVerschueren/decode-uri-component
             */
            const decodePath = encodedPath => {
                const token = '%[a-f0-9]{2}';
                const singleMatcher = new RegExp(token, 'gi');
                const multiMatcher = new RegExp(`(${token})+`, 'gi');

                function decodeComponents(components, split) {
                    try {
                        // Try to decode the entire string first
                        return decodeURIComponent(components.join(''));
                    } catch (err) {
                        // Do nothing
                    }

                    if (components.length === 1) {
                        return components;
                    }

                    split = split || 1;

                    // Split the array in 2 parts
                    const left = components.slice(0, split);
                    const right = components.slice(split);

                    return Array.prototype.concat.call([], decodeComponents(left), decodeComponents(right));
                }

                function decode(input) {
                    try {
                        return decodeURIComponent(input);
                    } catch (err) {
                        let tokens = input.match(singleMatcher);

                        for (let i = 1; i < tokens.length; i++) {
                            input = decodeComponents(tokens, i).join('');

                            tokens = input.match(singleMatcher);
                        }

                        return input;
                    }
                }

                function customDecodeURIComponent(input) {
                    // Keep track of all the replacements and prefill the map with the `BOM`
                    const replaceMap = {
                        '%FE%FF': '\uFFFD\uFFFD',
                        '%FF%FE': '\uFFFD\uFFFD',
                    };

                    let match = multiMatcher.exec(input);
                    while (match) {
                        try {
                            // Decode as big chunks as possible
                            replaceMap[match[0]] = decodeURIComponent(match[0]);
                        } catch (err) {
                            const result = decode(match[0]);

                            if (result !== match[0]) {
                                replaceMap[match[0]] = result;
                            }
                        }

                        match = multiMatcher.exec(input);
                    }

                    // Add `%C2` at the end of the map to make sure it does not replace the combinator before everything else
                    replaceMap['%C2'] = '\uFFFD';

                    const entries = Object.keys(replaceMap);

                    for (let i = 0; i < entries.length; i++) {
                        // Replace all decoded components
                        const key = entries[i];
                        input = input.replace(new RegExp(key, 'g'), replaceMap[key]);
                    }

                    return input;
                }

                if (typeof encodedPath !== 'string') {
                    throw new TypeError(
                        `Expected \`encodedPath\` to be of type \`string\`, got \`${typeof encodedPath}\``
                    );
                }

                try {
                    encodedPath = encodedPath.replace(/\+/g, ' ');

                    // Try the built in decoder first
                    return decodeURIComponent(encodedPath);
                } catch (err) {
                    // Fallback to a more advanced decoder
                    return customDecodeURIComponent(encodedPath);
                }
            };

            const displaySlug = string => {
                let pathSlug = '';
                try {
                    pathSlug = slugify(string) || '...';
                } catch (err) {
                    pathSlug = 'derp';
                    console.error('Parameter `url` must contain valid UTF-8 character sequences');
                }
                document.querySelector('h1').textContent = pathSlug;
                document.querySelector('title').textContent = pathSlug + '  - slugit';
            };
            /*
             * We receive the path as an URL encoded string.
             * Which means an `√°` will be represented as `%C3%A1`.
             * So we use decodePath to get the decoded string.
             */
            const pathname = window.location.href.replace(window.location.origin, '');
            if (pathname === '/') {
                document.querySelector('p').innerHTML = `Use it like this:<br><a href="${
                    window.location.origin
                }/give me a slug">${window.location.origin}/give me a slug`;
            }
            const defaultt = '...or write here';
            const path = decodePath(pathname);
            displaySlug(path !== '/' ? path : defaultt);

            document.querySelector('input').value = path.slice(1) || defaultt;
            document.querySelector('input').addEventListener('keyup', event => {
                displaySlug(event.target.value);
            });

            document.querySelector('h1').addEventListener('click', e => copyToClipboard(e.target.textContent));
        </script>

        <script>
            navigator.serviceWorker.register('/service-worker.js');
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('Service Worker changed, reload');
                window.location.reload();
            });
        </script>
    </body>
</html>
